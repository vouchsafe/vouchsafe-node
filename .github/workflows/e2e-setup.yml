name: E2E Setup

on:
  repository_dispatch:
    types: [spec-ready]
  workflow_dispatch:

jobs:
  test-sdk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout SDK repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Download OpenAPI spec
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: npm SDK Test
          repo: ${{ github.event.client_payload.repo }}
          run_id: ${{ github.event.client_payload.run_id }}
          name: openapi-spec-${{ github.event.client_payload.sha }}
          path: ./spec

      - name: Install dependencies
        run: npm ci

      - name: Generate model exports
        run: npx tsx scripts/generate-model-exports.ts

      - name: Generate SDK
        run: |
          npx openapi-generator-cli generate \
            -i ./spec/swagger.json \
            -g typescript-fetch \
            -o src/openapi \
            --skip-validate-spec \
            --additional-properties=modelPropertyNaming=original
          npm run generate:exports

      # - name: Run tests
      #   run: npm run test:ci
      #   env:
      #     TEST_CLIENT_ID: secrets.TEST_CLIENT_ID }}
      #     TEST_CLIENT_SECRET: ${{ secrets.TEST_CLIENT_SECRET }}

      # Report success back to API repo (if this was triggered by a PR)
      - name: Report success to API repo
        if: github.event.client_payload.is_pr == 'true' && success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            await github.rest.repos.createCommitStatus({
              owner: '${{ github.event.client_payload.repo }}'.split('/')[0],
              repo: '${{ github.event.client_payload.repo }}'.split('/')[1],
              sha: '${{ github.event.client_payload.sha }}',
              state: 'success',
              context: 'SDK Generation & Tests',
              description: 'SDK generated and all tests passed ✅',
              target_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            });

      # Report failure back to API repo (if this was triggered by a PR)
      - name: Report failure to API repo
        if: github.event.client_payload.is_pr == 'true' && failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            await github.rest.repos.createCommitStatus({
              owner: '${{ github.event.client_payload.repo }}'.split('/')[0],
              repo: '${{ github.event.client_payload.repo }}'.split('/')[1],
              sha: '${{ github.event.client_payload.sha }}',
              state: 'failure',
              context: 'SDK Generation & Tests',
              description: 'SDK tests failed ❌',
              target_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            });
